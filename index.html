<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Channel Analytics Battle</title>
    
    <!-- 1. Load React & ReactDOM (Stable) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Load Dependencies for Recharts -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-is/umd/react-is.production.min.js"></script>
    
    <!-- 3. Load Recharts -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>

    <!-- 4. Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 5. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 6. Load Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- 7. Load FontAwesome (For Infographic Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- 8. Load Html2Canvas & Mermaid -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>

    <!-- 9. Icon Components (Lucide via SVG) -->
    <script type="text/babel">
        const IconWrapper = ({ children, className, size = 24, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Trophy = (props) => <IconWrapper {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconWrapper>;
        const Activity = (props) => <IconWrapper {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Swords = (props) => <IconWrapper {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" x2="9" y1="14" y2="18"/><line x1="7" x2="4" y1="17" y2="20"/><line x1="3" x2="5" y1="19" y2="21"/></IconWrapper>;
        const Brain = (props) => <IconWrapper {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconWrapper>;
        const RefreshCw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>;
        const Plus = (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
        const X = (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const BarChart2 = (props) => <IconWrapper {...props}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconWrapper>;
        const Clock = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>;
        const Zap = (props) => <IconWrapper {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>;
        const Timer = (props) => <IconWrapper {...props}><path d="M10 2h4"/><path d="M12 14v-4"/><path d="M4 13a8 8 0 0 1 8-7 8 8 0 1 1-8 7"/></IconWrapper>;
        const Type = (props) => <IconWrapper {...props}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></IconWrapper>;
        const Box = (props) => <IconWrapper {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconWrapper>;
        const Info = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconWrapper>;
        const Users = (props) => <IconWrapper {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>;
    </script>
</head>
<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = Recharts;

        // --- Configuration ---
        const COLORS = [
          '#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
        ];

        // --- Utility: Helper Functions ---
        const parseDuration = (isoDuration) => {
            if (!isoDuration) return 0;
            const durationStr = isoDuration.toString().trim();
            if (durationStr.startsWith('PT')) {
                const match = durationStr.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
                if (!match) return 0;
                const hours = (parseInt(match[1]) || 0);
                const minutes = (parseInt(match[2]) || 0);
                const seconds = (parseInt(match[3]) || 0);
                return (hours * 60) + minutes + (seconds / 60);
            }
            if (durationStr.includes(':')) {
                const parts = durationStr.split(':').map(Number);
                let h = 0, m = 0, s = 0;
                if (parts.length === 3) { [h, m, s] = parts; } 
                else if (parts.length === 2) { [m, s] = parts; }
                return (h * 60) + m + (s / 60);
            }
            return 0;
        };

        const parseCSV = (text) => {
          const lines = text.split('\n').filter(line => line.trim() !== '');
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          return lines.slice(1).map(line => {
            const values = [];
            let currentVal = '';
            let inQuote = false;
            for (let i = 0; i < line.length; i++) {
              if (line[i] === '"') { inQuote = !inQuote; continue; }
              if (line[i] === ',' && !inQuote) { values.push(currentVal); currentVal = ''; }
              else { currentVal += line[i]; }
            }
            values.push(currentVal);
            const row = {};
            headers.forEach((header, index) => {
              row[header] = values[index]?.trim().replace(/"/g, '');
            });
            return row;
          });
        };

        // --- AI Analysis Logic ---
        const analyzeData = async (channels, bestTime, bestDuration, topKeywords, apiKey) => {
            const winner = channels.reduce((prev, current) => (prev.totalViews > current.totalViews) ? prev : current);
            const daysFull = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
            
            // Prepare Real Data Strings
            const realDay = bestTime.val > 0 ? daysFull[bestTime.day] : "N/A";
            const realTime = bestTime.val > 0 ? `${bestTime.hour}:00` : "N/A";
            const realDuration = bestDuration.avg > 0 ? bestDuration.label : "N/A";
            const topKwStr = topKeywords.map(k => k.word).join(", ");
            const engagementScore = parseFloat(winner.engagementRate);

            // 1. If API Key is provided -> Call Gemini API (Enhanced Prompt)
            if (apiKey && apiKey.length > 10) {
                const prompt = `
Role: You are an expert YouTube Producer and Digital Marketing Strategist.
Task: Analyze the provided channel data and generate highly specific, actionable, and deep insights in Thai (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢). The analysis must be strictly GENERIC and applicable to ANY content type (Education, Vlog, Tech, Gaming, etc.). DO NOT mention ghosts, horror, or fear.

Data:
- Market Leader Channel: "${winner.name}" (Views: ${winner.totalViews.toLocaleString()}, Engagement Rate: ${winner.engagementRate}%)
- Golden Hour (Best Upload Time): ${realDay} at ${realTime} (based on historical peak views)
- Winning Duration Sweet Spot: ${realDuration}
- High-Impact Keywords: ${topKwStr}

Output Requirements (Strictly follow this structure):

1. **Content Structure & Retention (Producer's Eye):**
   - Analyze why ${realDuration} works for this audience. Does high/low engagement (${winner.engagementRate}%) imply deep connection or broad reach?
   - Suggest a specific "Hook" technique for the first 30 seconds (e.g., "The Payoff Tease", "In Media Res", or "Question-Led").
   - If engagement is high (>4%), suggest how to leverage community (e.g., Q&A, Comments reply). If low, suggest pacing improvements (cuts, b-roll).

2. **Audience Behavior Insight (Marketer's Eye):**
   - Interpret the Golden Hour (${realDay} ${realTime}) deeply. Who is watching? (e.g., "Commuters", "Lunch breakers", "Weekend binge-watchers").
   - Suggest a distribution routine (e.g., Shorts remixing, Cross-platform promotion).

3. **Optimization Strategy (Advanced CTR & SEO):**
   - **Visual Strategy (Thumbnail):** Suggest universal design principles. Focus on "Focal Point", "Rule of Thirds", "Color Psychology (Blue/Orange or High Contrast)", and "Text Readability".
   - **Title Formula:** Create 2 specific example titles using the keywords: "${topKwStr}". Use formulas like [Keyword] + [Benefit/Promise] + [Curiosity/Urgency].
   - **SEO:** Suggest using long-tail variations of the main keywords.

Tone: Professional, Data-driven, Action-oriented (No fluff).
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content) {
                        return result.candidates[0].content.parts[0].text;
                    }
                } catch (error) {
                    console.error("API Error:", error);
                    return "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini API: " + error.message + " (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ Smart Simulation ‡πÅ‡∏ó‡∏ô)";
                }
            }

            // 2. If NO API Key -> Smart Simulation (Dynamic & Deep Templates - GENERIC)
            // Logic for Producer View
            let producerInsight = "";
            if (engagementScore > 4.0) {
                producerInsight = `- **Community-Driven Content:** Engagement Rate ‡∏ó‡∏µ‡πà ${engagementScore}% ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏î‡∏π‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏±‡∏Å‡∏î‡∏µ‡∏™‡∏π‡∏á (Loyal Fanbase) \n   - **Strategy:** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á (Co-creator) ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Q&A) ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`;
            } else {
                producerInsight = `- **Focus on Pacing:** ‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß‡∏î‡∏µ‡πÅ‡∏ï‡πà Engagement ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏µ‡∏Ñ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡πÄ‡∏¢‡∏∑‡πâ‡∏≠ \n   - **Strategy:** ‡πÉ‡∏ä‡πâ‡∏Å‡∏é "10-Second Rule" ‡∏Ñ‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à (‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà/‡∏°‡∏∏‡∏Ç‡∏ï‡∏•‡∏Å) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏Ñ‡∏ô‡∏î‡∏π`;
            }

            // Logic for Marketer View
            let marketerInsight = "";
            const isNight = (bestTime.hour >= 18 || bestTime.hour <= 2);
            if (isNight) {
                marketerInsight = `- **Prime Time Viewer:** ‡πÄ‡∏ß‡∏•‡∏≤ ${realTime} ‡∏ß‡∏±‡∏ô${realDay} ‡∏Ñ‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô/‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô \n   - **Context:** ‡∏Ñ‡∏ô‡∏î‡∏π‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô (Lean-back) ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å (In-depth) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡πÜ (Storytelling) ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡∏£‡∏µ‡∏ö`;
            } else {
                marketerInsight = `- **On-the-Go Viewer:** ‡πÄ‡∏ß‡∏•‡∏≤ ${realTime} ‡∏ß‡∏±‡∏ô${realDay} ‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏î‡∏π‡∏≠‡∏≤‡∏à‡∏î‡∏π‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ \n   - **Context:** ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (Snackable) ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ö‡∏ô‡∏à‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏û‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏´‡∏π‡∏ü‡∏±‡∏á`;
            }

            // Logic for Optimization (Specific Examples - GENERIC)
            const keywordsText = topKeywords.length > 0 ? topKeywords.map(k => `"${k.word}"`).join(", ") : "Keyword ‡∏´‡∏•‡∏±‡∏Å";
            const sampleTitle = topKeywords.length > 0 
                ? `"${topKeywords[0].word}: ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å... (‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)"` 
                : `"‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏£‡πâ‡∏≠‡∏ô: ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ß‡∏£‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ"`;

            return `‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå (Smart Simulation - General Content):\n\n1. **Content Structure & Retention (‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á Producer):**\n   ${producerInsight}\n   - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß **"${realDuration}"** ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏µ‡πà Algorithm ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Long-form content ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó (Chapters) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏î‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô\n\n2. **Audience Behavior Insight (‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î):**\n   ${marketerInsight}\n\n3. **Optimization Strategy (CTR & Thumbnail):**\n   - **Visual Strategy:** ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ **"Less is More"** ‡∏ö‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏•‡∏¥‡∏õ \n     1. **Subject:** ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏Ñ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà 60% ‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û) \n     2. **Text:** ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ñ‡πà 3-4 ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß "‡∏™‡∏∞‡∏î‡∏∏‡∏î" (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥) \n     3. **Contrast:** ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏∑‡πâ‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô-‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡πÉ‡∏ô Dark Mode\n   - **Title Formula:** ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£ [Keyword ‡∏´‡∏•‡∏±‡∏Å] + [‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏î‡∏π‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ] + [‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç]\n   - **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ:** ${sampleTitle}\n   - **Keyword Winning:** ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ${keywordsText} ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏µ Traffic ‡∏î‡∏µ ‡∏Ñ‡∏ß‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Playlist ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß (Evergreen Content)`;
        };

        // --- UPDATED: System Info Modal (Mermaid + Html2Canvas) ---
        const SystemInfoModal = ({ isOpen, onClose }) => {
            const captureRef = useRef(null);
            const [downloadState, setDownloadState] = useState('idle'); // idle, loading, success, error

            useEffect(() => {
                if (isOpen && window.mermaid) {
                    // Initialize Mermaid when modal opens
                    window.mermaid.initialize({
                        startOnLoad: true,
                        theme: 'dark',
                        securityLevel: 'loose',
                        fontFamily: 'Kanit'
                    });
                    // Force render
                    window.mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                }
            }, [isOpen]);

            const handleDownload = () => {
                if (!captureRef.current) return;
                setDownloadState('loading');
                
                html2canvas(captureRef.current, {
                    backgroundColor: "#1e293b", // Slate-800 match
                    scale: 2,
                    useCORS: true,
                    // üî• FIX: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Gradient Text ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏ï‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    onclone: (clonedDoc) => {
                        const titleElement = clonedDoc.getElementById('capture-area').querySelector('h1');
                        if (titleElement) {
                            // ‡∏•‡∏ö Class ‡∏ó‡∏µ‡πà‡∏ó‡∏≥ Gradient ‡∏≠‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û
                            titleElement.classList.remove('text-transparent', 'bg-clip-text', 'bg-gradient-to-r');
                            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏∂‡∏ö‡πÅ‡∏ó‡∏ô (‡∏™‡∏µ‡∏ü‡πâ‡∏≤ Indigo)
                            titleElement.style.color = '#818cf8'; 
                            titleElement.style.backgroundImage = 'none';
                            titleElement.style.webkitTextFillColor = 'initial';
                        }
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'system-architecture-infographic.png';
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    setDownloadState('success');
                    setTimeout(() => setDownloadState('idle'), 2000);
                }).catch(err => {
                    console.error("Screenshot failed", err);
                    setDownloadState('error');
                });
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="relative w-full max-w-5xl max-h-[90vh] overflow-y-auto rounded-3xl bg-slate-900 border border-slate-700 shadow-2xl">
                        
                        {/* Close Button */}
                        <button onClick={onClose} className="absolute top-4 right-4 z-50 text-slate-400 hover:text-white bg-slate-800/50 hover:bg-slate-700 p-2 rounded-full transition-all">
                            <X size={24} />
                        </button>

                        {/* Capture Area */}
                        <div ref={captureRef} id="capture-area" className="p-8 md:p-12 relative bg-slate-800 overflow-hidden">
                            {/* Background Decor */}
                            <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                            <div className="absolute bottom-0 left-0 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl -ml-16 -mb-16 pointer-events-none"></div>

                            <div className="text-center mb-8 relative z-10">
                                <h1 className="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2 font-['Kanit']">
                                    CHANNEL ANALYTICS BATTLE
                                </h1>
                                <p className="text-slate-400 text-lg font-['Kanit']">System Architecture & Data Pipeline Flow</p>
                            </div>

                            {/* Mermaid Diagram */}
                            <div className="mermaid flex justify-center relative z-10 my-8">
{`graph LR
    subgraph Data_Collection ["1. Data Collection (Automation)"]
    direction TB
    YT[<i class="fab fa-youtube"></i> YouTube Data API v3]
    N8N[<i class="fas fa-bolt"></i> n8n Workflow]
    YT -->|Fetch Stats| N8N
    N8N -->|Process Data| N8N_Logic{Logic Split}
    end

    subgraph Database ["2. Data Storage (Google Sheets)"]
    direction TB
    GS[<i class="fas fa-table"></i> Google Sheets]
    DIM[(dim_videos_update<br/>Store Metadata)]
    FACT[(fact_video_stats<br/>Store History)]

    N8N_Logic -->|Update/Upsert| DIM
    N8N_Logic -->|Append New Row| FACT
    DIM -.-> GS
    FACT -.-> GS
    end

    subgraph Visualization ["3. Frontend & AI (Web App)"]
    direction TB
    WEB[<i class="fas fa-laptop-code"></i> React Web App]
    DASH[Dashboard & Charts]
    AI[<i class="fas fa-brain"></i> Gemini AI Analysis]

    GS -->|Export CSV| WEB
    WEB --> DASH
    WEB -->|Context Data| AI
    AI -->|Insights| DASH
    end

    classDef youtube fill:#FF0000,stroke:#333,stroke-width:2px,color:white;
    classDef n8n fill:#FF6D5A,stroke:#333,stroke-width:2px,color:white;
    classDef sheets fill:#0F9D58,stroke:#333,stroke-width:2px,color:white;
    classDef web fill:#61DAFB,stroke:#333,stroke-width:2px,color:black;
    classDef ai fill:#8E75B2,stroke:#333,stroke-width:2px,color:white;

    class YT youtube;
    class N8N n8n;
    class GS,DIM,FACT sheets;
    class WEB web;
    class AI ai;`}
                            </div>

                            {/* Info Grid */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12 text-center relative z-10 font-['Kanit']">
                                <div className="p-4 bg-slate-700/50 rounded-xl border border-slate-600">
                                    <div className="text-orange-400 font-bold text-xl mb-2"><i className="fas fa-robot mr-2"></i>1. n8n Automation</div>
                                    <p className="text-sm text-slate-300">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ä‡πà‡∏≠‡∏á (Views, Likes, Comments) ‡∏à‡∏≤‡∏Å YouTube API ‡∏ï‡∏≤‡∏° Channel ID ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ</p>
                                </div>
                                <div className="p-4 bg-slate-700/50 rounded-xl border border-slate-600">
                                    <div className="text-green-400 font-bold text-xl mb-2"><i className="fas fa-database mr-2"></i>2. Google Sheets</div>
                                    <p className="text-sm text-slate-300">‡πÅ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: Dimension (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡πÅ‡∏•‡∏∞ Fact (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</p>
                                </div>
                                <div className="p-4 bg-slate-700/50 rounded-xl border border-slate-600">
                                    <div className="text-blue-400 font-bold text-xl mb-2"><i className="fas fa-chart-line mr-2"></i>3. React + Gemini AI</div>
                                    <p className="text-sm text-slate-300">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡πâ‡∏ß‡∏¢ Recharts/Plotly ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ Gemini AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á</p>
                                </div>
                            </div>
                            
                            <div className="text-center mt-8 relative z-10">
                                <p className="text-slate-500 text-xs mb-1">Generated for Channel Analytics Battle Project</p>
                                <p className="text-slate-400 text-sm font-bold font-['Kanit']">
                                    by Thitikorn Sapanguen(SDA), Natpaphon Nukhunthod(DS)
                                </p>
                            </div>
                        </div>

                        {/* Footer Controls */}
                        <div className="p-4 bg-slate-900 border-t border-slate-800 flex justify-end items-center gap-4 sticky bottom-0 z-20">
                             <button 
                                onClick={handleDownload} 
                                disabled={downloadState === 'loading'}
                                className={`px-6 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 transition-all ${
                                    downloadState === 'success' ? 'bg-green-600 text-white hover:bg-green-500' :
                                    downloadState === 'error' ? 'bg-red-600 text-white' :
                                    'bg-blue-600 hover:bg-blue-500 text-white hover:scale-105'
                                }`}
                            >
                                {downloadState === 'loading' && <i className="fas fa-spinner fa-spin"></i>}
                                {downloadState === 'success' && <i className="fas fa-check"></i>}
                                {downloadState === 'error' && <i className="fas fa-exclamation-triangle"></i>}
                                {downloadState === 'idle' && <i className="fas fa-camera"></i>}
                                
                                {downloadState === 'loading' ? 'Generating...' : 
                                 downloadState === 'success' ? 'Downloaded!' : 
                                 downloadState === 'error' ? 'Failed' : 
                                 'Download Image (PNG)'}
                            </button>
                            <button onClick={onClose} className="text-slate-400 hover:text-white px-4 py-2 font-['Kanit']">
                                ‡∏õ‡∏¥‡∏î
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Card = ({ children, className = "" }) => (
          <div className={`bg-slate-800 rounded-xl border border-slate-700 shadow-xl overflow-hidden ${className}`}>
            {children}
          </div>
        );

        const StatBox = ({ label, value, subtext, color = "text-white", align = "left" }) => (
          <div className={`flex flex-col ${align === 'right' ? 'items-end text-right' : (align === 'center' ? 'items-center text-center' : 'items-start text-left')}`}>
            <span className="text-slate-400 text-xs uppercase tracking-wider font-semibold mb-1">{label}</span>
            <span className={`text-xl md:text-2xl font-bold font-mono ${color}`}>{value}</span>
            {subtext && <span className="text-slate-500 text-[10px] mt-1">{subtext}</span>}
          </div>
        );

        const HeatmapCell = ({ value, max, day, hour }) => {
            const intensity = max > 0 ? value / max : 0;
            const bgColor = value > 0 ? `rgba(239, 68, 68, ${0.2 + (intensity * 0.8)})` : 'rgba(30, 41, 59, 0.5)';
            return (
                <div className="group relative w-full pt-[100%] rounded-sm cursor-pointer transition-all hover:ring-2 hover:ring-white z-0 hover:z-10" 
                     style={{ backgroundColor: bgColor }}
                     title={`${['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'][day]} ${hour}:00 - ${Math.round(value).toLocaleString()} views`}
                >
                    <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                         <span className="text-[10px] font-bold text-white drop-shadow-md bg-black/50 px-1 rounded">
                             {value > 1000 ? (Math.round(value)/1000).toFixed(1)+'k' : Math.round(value)}
                         </span>
                    </div>
                </div>
            );
        };

        // --- 3D Chart Component ---
        const GhostDataverse = ({ data, selectedChannels, colors }) => {
            const chartRef = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !data.length || !window.Plotly) return;

                // --- 1. Calculate Max Values for Zones ---
                let maxDuration = 0;
                let maxEngagement = 0;
                let maxViews = 0;

                const relevantData = data.filter(d => selectedChannels.some(c => d.channel_title?.toLowerCase() === c.toLowerCase()));
                
                relevantData.forEach(d => {
                    if (d.duration > maxDuration) maxDuration = d.duration;
                    if (d.views > maxViews) maxViews = d.views;
                    const eng = d.views > 0 ? ((d.likes + d.comments) / d.views) * 100 : 0;
                    if (eng > maxEngagement) maxEngagement = eng;
                });

                maxDuration = maxDuration || 60;
                maxEngagement = maxEngagement || 5;
                maxViews = maxViews || 10000;
                
                const midEng = maxEngagement / 2;
                const midViews = maxViews / 2;
                const opacityVal = 0.2;

                // --- 2. Define Zone Traces (Mesh3D) ---
                const viralZone = {
                    type: 'mesh3d',
                    x: [0, 0, maxDuration, maxDuration, 0, 0, maxDuration, maxDuration],
                    y: [midEng, maxEngagement, maxEngagement, midEng, midEng, maxEngagement, maxEngagement, midEng],
                    z: [midViews, midViews, midViews, midViews, maxViews, maxViews, maxViews, maxViews],
                    i: [7, 0, 0, 0, 4, 4, 6, 6, 4, 0, 3, 2],
                    j: [3, 4, 1, 2, 5, 6, 5, 2, 0, 1, 6, 3],
                    k: [0, 7, 2, 3, 6, 7, 1, 1, 5, 5, 7, 6],
                    color: '#22c55e', opacity: opacityVal, alphahull: 0, name: 'Viral Zone (Quality)', showlegend: true, hoverinfo: 'name'
                };

                const clickbaitZone = {
                    type: 'mesh3d',
                    x: [0, 0, maxDuration, maxDuration, 0, 0, maxDuration, maxDuration],
                    y: [0, midEng, midEng, 0, 0, midEng, midEng, 0],
                    z: [midViews, midViews, midViews, midViews, maxViews, maxViews, maxViews, maxViews],
                    i: [7, 0, 0, 0, 4, 4, 6, 6, 4, 0, 3, 2],
                    j: [3, 4, 1, 2, 5, 6, 5, 2, 0, 1, 6, 3],
                    k: [0, 7, 2, 3, 6, 7, 1, 1, 5, 5, 7, 6],
                    color: '#ef4444', opacity: opacityVal, alphahull: 0, name: 'Clickbait Zone', showlegend: true, hoverinfo: 'name'
                };

                const fanbaseZone = {
                    type: 'mesh3d',
                    x: [0, 0, maxDuration, maxDuration, 0, 0, maxDuration, maxDuration],
                    y: [midEng, maxEngagement, maxEngagement, midEng, midEng, maxEngagement, maxEngagement, midEng],
                    z: [0, 0, 0, 0, midViews, midViews, midViews, midViews],
                    i: [7, 0, 0, 0, 4, 4, 6, 6, 4, 0, 3, 2],
                    j: [3, 4, 1, 2, 5, 6, 5, 2, 0, 1, 6, 3],
                    k: [0, 7, 2, 3, 6, 7, 1, 1, 5, 5, 7, 6],
                    color: '#3b82f6', opacity: opacityVal, alphahull: 0, name: 'Fanbase Zone', showlegend: true, hoverinfo: 'name'
                };

                // --- 3. Create Scatter Traces ---
                const scatterTraces = selectedChannels.map((chName, index) => {
                    const chData = data.filter(d => d.channel_title?.toLowerCase() === chName.toLowerCase());
                    const color = colors[index % colors.length];
                    
                    const xValues = chData.map(d => d.duration); 
                    const zValues = chData.map(d => d.views);    
                    const yValues = chData.map(d => d.views > 0 ? ((d.likes + d.comments) / d.views) * 100 : 0);
                    const markerSizes = chData.map(d => Math.max(5, Math.min(30, Math.sqrt(d.comments) * 2))); 

                    return {
                        x: xValues, y: yValues, z: zValues, mode: 'markers', type: 'scatter3d', name: chName,
                        text: chData.map((d, i) => `<b>${d.title}</b><br>‚è± Duration: ${d.duration.toFixed(1)} m<br>‚ù§Ô∏è Engagement: ${yValues[i].toFixed(2)}%<br>üëÄ Views: ${d.views.toLocaleString()}<br>üí¨ Comments: ${d.comments.toLocaleString()}`),
                        marker: { size: markerSizes, color: color, opacity: 0.9, line: { color: 'white', width: 0.5 } }
                    };
                });

                const allTraces = [...scatterTraces, viralZone, clickbaitZone, fanbaseZone];
                const layout = {
                    title: { text: '3D Content Matrix: Length vs Engagement vs Reach', font: { color: '#fff' } },
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#94a3b8' },
                    margin: { l: 0, r: 0, b: 0, t: 40 },
                    scene: {
                        xaxis: { title: 'Duration (‡∏ô‡∏≤‡∏ó‡∏µ)', color: '#cbd5e1', gridcolor: '#334155' },
                        yaxis: { title: 'Engagement Rate (%)', color: '#cbd5e1', gridcolor: '#334155' },
                        zaxis: { title: 'Total Views (Reach)', color: '#cbd5e1', gridcolor: '#334155' },
                        camera: { eye: { x: 1.6, y: 1.6, z: 1.4 } }
                    },
                    legend: { font: { color: '#fff' }, bgcolor: 'rgba(0,0,0,0)' },
                    hoverlabel: { bgcolor: "#1e293b", font: { color: "#fff" } }
                };

                const config = { responsive: true, displayModeBar: true };
                window.Plotly.newPlot(chartRef.current, allTraces, layout, config);
                
                return () => { if (chartRef.current) window.Plotly.purge(chartRef.current); };
            }, [data, selectedChannels, colors]);

            return <div ref={chartRef} className="w-full h-[550px]"></div>;
        };

        // --- Key Takeaways Component ---
        const KeyTakeaways = ({ heatmapData, durationStats, days }) => {
            const bestDay = days[heatmapData.best.day];
            const bestTime = heatmapData.best.hour;
            
            return (
                <div className="p-6 bg-slate-900/50 border-t border-slate-700/50">
                    <h4 className="text-white font-bold mb-4 flex items-center gap-2">
                        <Info size={18} className="text-blue-400" /> Key Takeaways: ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </h4>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="space-y-3">
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-2">üîç ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏≤‡∏ü 3D (How to Read)</p>
                            <div className="flex items-start gap-3 text-sm text-slate-300"><div className="w-2 h-2 rounded-full bg-green-500 mt-1.5 shrink-0 opacity-50"></div><div><strong className="text-green-400">Viral Zone (‡∏™‡∏π‡∏á+‡∏•‡∏∂‡∏Å):</strong> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏à‡∏≤‡∏á‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ "‡∏Ñ‡∏ô‡∏î‡∏π‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡∏°‡∏≤‡∏Å" (Quality Content)</div></div>
                            <div className="flex items-start gap-3 text-sm text-slate-300"><div className="w-2 h-2 rounded-full bg-red-500 mt-1.5 shrink-0 opacity-50"></div><div><strong className="text-red-400">Clickbait Zone (‡∏™‡∏π‡∏á+‡∏ï‡∏∑‡πâ‡∏ô):</strong> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏à‡∏≤‡∏á‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ "‡∏Ñ‡∏ô‡∏Å‡∏î‡∏î‡∏π‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏ï‡πà Engagement ‡∏ï‡πà‡∏≥"</div></div>
                            <div className="flex items-start gap-3 text-sm text-slate-300"><div className="w-2 h-2 rounded-full bg-blue-500 mt-1.5 shrink-0 opacity-50"></div><div><strong className="text-blue-400">Fanbase Zone (‡πÄ‡∏ï‡∏µ‡πâ‡∏¢+‡∏•‡∏∂‡∏Å):</strong> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏à‡∏≤‡∏á‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ "‡∏Ñ‡∏ô‡∏î‡∏π‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å"</div></div>
                        </div>
                        <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50">
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-3">‚ö°Ô∏è Executive Summary (‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)</p>
                            <ul className="space-y-2 text-sm text-slate-200 list-disc list-inside">
                                <li>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏•‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏Ñ‡∏∑‡∏≠ <span className="text-yellow-400 font-bold">‡∏ß‡∏±‡∏ô{bestDay} ‡πÄ‡∏ß‡∏•‡∏≤ {bestTime}:00 ‡∏ô.</span> ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ô‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</li>
                                <li>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <span className="text-blue-400 font-bold">{durationStats.label}</span></li>
                                <li><span className="text-slate-400">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</span> ‡∏•‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ï‡∏¥‡∏î Viral ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        function GhostChannelBattleApp() {
          const [data, setData] = useState([]);
          const [loading, setLoading] = useState(true);
          const [selectedChannels, setSelectedChannels] = useState([]);
          const [tempSelected, setTempSelected] = useState('');
          
          const [aiKey, setAiKey] = useState('');
          const [aiAnalysis, setAiAnalysis] = useState(null);
          const [aiLoading, setAiLoading] = useState(false);
          
          const [isInfoModalOpen, setIsInfoModalOpen] = useState(false);

          useEffect(() => {
            const fetchData = async () => {
              try {
                const SHEET_ID = '1Lz6gNRhtu0R_PRYZqA61DCsXNFmgsJStO-k1KgnOKds';
                const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
                const response = await fetch(CSV_URL);
                const text = await response.text();
                const parsedData = parseCSV(text);
                const cleanedData = parsedData.map(row => ({
                  ...row,
                  views: parseInt(row.views?.replace(/,/g, '') || 0),
                  likes: parseInt(row.likes?.replace(/,/g, '') || 0),
                  comments: parseInt(row.comment_count?.replace(/,/g, '') || 0),
                  duration: row.duration ? parseDuration(row.duration) : 0,
                  title: row.title || '',
                  date: new Date(row.published_at)
                })).filter(r => r.channel_title);
                setData(cleanedData);
                setLoading(false);
                if (cleanedData.length > 0) {
                   const uniqueChannels = [...new Set(cleanedData.map(d => d.channel_title))].filter(Boolean);
                   if (uniqueChannels.length > 0) {
                     setTempSelected(uniqueChannels[0]);
                     setSelectedChannels([uniqueChannels[0]]);
                   }
                }
              } catch (err) {
                console.error("Error fetching data:", err);
                setLoading(false);
              }
            };
            fetchData();
          }, []);

          // Stats Logic
          const channelStats = useMemo(() => {
            return selectedChannels.map((chName, index) => {
              const chData = data.filter(d => d.channel_title?.toLowerCase() === chName.toLowerCase());
              if (!chData.length) return { name: chName, totalViews: 0, totalLikes: 0, avgViews: 0, count: 0, engagementRate: 0, color: COLORS[index % COLORS.length] };
              const totalViews = chData.reduce((sum, r) => sum + r.views, 0);
              const totalLikes = chData.reduce((sum, r) => sum + r.likes, 0);
              const engagementRate = totalViews > 0 ? ((totalLikes / totalViews) * 100).toFixed(2) : 0;
              return { name: chData[0]?.channel_title || chName, totalViews, totalLikes, avgViews: Math.round(totalViews / chData.length), count: chData.length, engagementRate, color: COLORS[index % COLORS.length] };
            }).sort((a, b) => b.totalViews - a.totalViews);
          }, [data, selectedChannels]);

          // Heatmap Logic
          const heatmapData = useMemo(() => {
              const grid = Array(7).fill().map(() => Array(24).fill({ total: 0, count: 0 }));
              const filteredData = data.filter(d => selectedChannels.some(c => d.channel_title?.toLowerCase() === c.toLowerCase()));
              filteredData.forEach(video => {
                  if (video.date && !isNaN(video.date)) {
                      const day = video.date.getDay();
                      const hour = video.date.getHours();
                      grid[day][hour] = { total: grid[day][hour].total + video.views, count: grid[day][hour].count + 1 };
                  }
              });
              let maxAvg = 0;
              let bestTime = { day: 0, hour: 0, val: 0 };
              const finalGrid = grid.map((dayRow, dIdx) => dayRow.map((cell, hIdx) => {
                  const avg = cell.count > 0 ? cell.total / cell.count : 0;
                  if (avg > maxAvg) maxAvg = avg;
                  if (avg > bestTime.val) bestTime = { day: dIdx, hour: hIdx, val: avg };
                  return avg;
              }));
              return { grid: finalGrid, max: maxAvg, best: bestTime };
          }, [data, selectedChannels]);

          // Duration Logic
          const durationStats = useMemo(() => {
             const filteredData = data.filter(d => selectedChannels.some(c => d.channel_title?.toLowerCase() === c.toLowerCase()));
             const buckets = { '‡∏™‡∏±‡πâ‡∏ô (<10m)': { total: 0, count: 0 }, '‡∏Å‡∏•‡∏≤‡∏á (10-30m)': { total: 0, count: 0 }, '‡∏¢‡∏≤‡∏ß (>30m)': { total: 0, count: 0 } };
             filteredData.forEach(v => {
                 if(v.duration < 10) { buckets['‡∏™‡∏±‡πâ‡∏ô (<10m)'].total += v.views; buckets['‡∏™‡∏±‡πâ‡∏ô (<10m)'].count++; }
                 else if(v.duration <= 30) { buckets['‡∏Å‡∏•‡∏≤‡∏á (10-30m)'].total += v.views; buckets['‡∏Å‡∏•‡∏≤‡∏á (10-30m)'].count++; }
                 else { buckets['‡∏¢‡∏≤‡∏ß (>30m)'].total += v.views; buckets['‡∏¢‡∏≤‡∏ß (>30m)'].count++; }
             });
             let winner = { label: 'N/A', avg: 0 };
             Object.entries(buckets).forEach(([key, val]) => {
                 const avg = val.count > 0 ? val.total / val.count : 0;
                 if(avg > winner.avg) winner = { label: key, avg };
             });
             return winner;
          }, [data, selectedChannels]);

          // Keyword Logic
          const keywordStats = useMemo(() => {
             const filteredData = data.filter(d => selectedChannels.some(c => d.channel_title?.toLowerCase() === c.toLowerCase()));
             const wordMap = {};
             filteredData.forEach(v => {
                 if(!v.title) return;
                 const words = v.title.replace(/[|()\[\]]/g, '').split(/\s+/);
                 words.forEach(w => {
                     if(w.length > 2 && !['EP.', 'The', 'Ghost'].includes(w)) {
                        if(!wordMap[w]) wordMap[w] = { total: 0, count: 0 };
                        wordMap[w].total += v.views;
                        wordMap[w].count++;
                     }
                 });
             });
             return Object.entries(wordMap)
                .map(([word, stat]) => ({ word, avg: stat.total/stat.count, count: stat.count }))
                .filter(x => x.count >= 2)
                .sort((a,b) => b.avg - a.avg)
                .slice(0, 3);
          }, [data, selectedChannels]);

          const channelList = useMemo(() => [...new Set(data.map(d => d.channel_title))].filter(Boolean), [data]);
          const addChannel = () => { if (tempSelected && !selectedChannels.includes(tempSelected)) setSelectedChannels([...selectedChannels, tempSelected]); };
          const removeChannel = (channel) => { if (selectedChannels.length > 1) setSelectedChannels(selectedChannels.filter(c => c !== channel)); else alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö"); };
          
          const handleAIAnalyze = async () => { 
              setAiLoading(true); 
              const result = await analyzeData(channelStats, heatmapData.best, durationStats, keywordStats, aiKey); 
              setAiAnalysis(result); 
              setAiLoading(false); 
          };

          if (loading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>;

          const days = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];

          return (
            <div className="min-h-screen bg-slate-950 text-slate-200 font-sans pb-20">
              <SystemInfoModal isOpen={isInfoModalOpen} onClose={() => setIsInfoModalOpen(false)} />
              
              <div className="bg-slate-900 border-b border-slate-800 sticky top-0 z-50 shadow-lg">
                <div className="max-w-7xl mx-auto px-4 py-4 space-y-4">
                  <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div className="flex items-center gap-3">
                      <div className="bg-gradient-to-br from-red-600 to-purple-700 p-2 rounded-lg shadow-lg">
                        <Swords className="text-white w-6 h-6" />
                      </div>
                      <div>
                        <h1 className="text-xl font-bold text-white tracking-tight uppercase">Channel Analytics Battle</h1>
                        <p className="text-xs text-slate-400">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Youtube</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                       <button onClick={() => setIsInfoModalOpen(true)} className="bg-slate-800 hover:bg-slate-700 text-slate-300 p-2 rounded-lg border border-slate-700 transition-colors mr-2" title="System Architecture">
                           <Info size={20} />
                       </button>
                       <div className="flex items-center gap-2 bg-slate-800 p-1.5 rounded-lg border border-slate-700 shadow-inner">
                          <select className="bg-transparent text-slate-200 font-bold outline-none px-2 py-1 cursor-pointer hover:bg-slate-700 rounded text-sm w-40 md:w-56" value={tempSelected} onChange={e => setTempSelected(e.target.value)}>
                            {channelList.map(c => <option key={c} value={c} className="bg-slate-800 text-white">{c}</option>)}
                          </select>
                          <button onClick={addChannel} className="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors flex items-center gap-1 text-sm font-bold"><Plus size={16} /> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á</button>
                       </div>
                    </div>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {selectedChannels.map((ch, idx) => {
                      const color = COLORS[idx % COLORS.length];
                      return (
                        <div key={ch} className="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-700 text-sm shadow-sm transition-all hover:border-slate-500 animate-in fade-in slide-in-from-top-1 duration-300">
                          <div className="w-2 h-2 rounded-full" style={{ backgroundColor: color }}></div>
                          <span className="font-bold text-slate-200">{ch}</span>
                          <button onClick={() => removeChannel(ch)} className="text-slate-500 hover:text-red-400 ml-1"><X size={14} /></button>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>

              <main className="max-w-7xl mx-auto px-4 py-8 space-y-8">
                {/* Stats Cards */}
                <div className={`grid grid-cols-1 md:grid-cols-2 ${selectedChannels.length >= 3 ? 'lg:grid-cols-3 xl:grid-cols-4' : ''} gap-6`}>
                  {channelStats.map((stat, idx) => (
                      <Card key={stat.name} className="relative border-t-4 transition-transform hover:-translate-y-1" style={{ borderTopColor: stat.color }}>
                        {idx === 0 && channelStats.length > 1 && (
                           <div className="absolute top-0 right-0 p-2 bg-yellow-500/20 text-yellow-400 rounded-bl-xl border-l border-b border-yellow-500/20 z-10"><Trophy size={16} /></div>
                        )}
                        <div className="p-5">
                          <div className="flex items-center gap-3 mb-4">
                            <div className="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg text-white shadow-lg shrink-0" style={{ backgroundColor: stat.color }}>{stat.name.charAt(0)}</div>
                            <h2 className="text-lg font-bold text-white truncate w-full" title={stat.name}>{stat.name}</h2>
                          </div>
                          <div className="space-y-4">
                            <StatBox label="‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß‡∏£‡∏ß‡∏° (Total Views)" value={stat.totalViews.toLocaleString()} color="text-white" />
                            <div className="grid grid-cols-2 gap-2">
                               <StatBox label="‡∏ß‡∏¥‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Ñ‡∏•‡∏¥‡∏õ" value={Math.round(stat.avgViews).toLocaleString()} color="text-slate-300" />
                               <StatBox label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ" value={stat.count} color="text-slate-300" align="right" />
                            </div>
                            <div className="pt-3 border-t border-slate-700/50 flex justify-between items-center">
                               <span className="text-xs text-slate-500">Engagement Rate</span>
                               <span className="text-sm font-bold text-green-400">{stat.engagementRate}%</span>
                            </div>
                          </div>
                        </div>
                      </Card>
                  ))}
                </div>

                {/* Charts Section */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                   <Card className="p-6 lg:col-span-2 h-[450px]">
                     <h3 className="text-lg font-bold text-slate-300 mb-6 flex items-center gap-2">
                       <BarChart2 size={20} className="text-purple-400" /> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
                     </h3>
                     <ResponsiveContainer width="100%" height="85%">
                       <BarChart data={channelStats} layout="vertical" margin={{ left: 40, right: 40 }}>
                         <CartesianGrid strokeDasharray="3 3" stroke="#334155" horizontal={false} />
                         <XAxis type="number" stroke="#94a3b8" hide />
                         <YAxis dataKey="name" type="category" stroke="#94a3b8" width={100} tick={{fill: '#cbd5e1', fontSize: 12}} />
                         <Tooltip contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', color: '#fff' }} cursor={{fill: 'rgba(255,255,255,0.05)'}} itemStyle={{ color: '#fff' }} />
                         <Bar dataKey="avgViews" name="Avg Views per Clip" radius={[0, 4, 4, 0]} barSize={30}>
                            {channelStats.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                         </Bar>
                       </BarChart>
                     </ResponsiveContainer>
                   </Card>

                   <Card className="p-6 h-[450px] flex flex-col relative">
                      <h3 className="text-lg font-bold text-slate-300 mb-2 w-full text-left flex items-center gap-2">
                          <Users size={20} className="text-yellow-400" /> Market Share
                      </h3>
                      <div className="flex-grow">
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={channelStats} cx="50%" cy="50%" innerRadius={60} outerRadius={100} paddingAngle={2} dataKey="totalViews">
                              {channelStats.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} stroke="rgba(0,0,0,0)" />)}
                            </Pie>
                            <Tooltip contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155' }} />
                            <Legend layout="horizontal" verticalAlign="bottom" align="center" wrapperStyle={{fontSize: '11px', paddingTop: '10px'}}/>
                          </PieChart>
                        </ResponsiveContainer>
                      </div>
                   </Card>
                </div>

                {/* Heatmap Section */}
                <Card className="p-6 overflow-x-auto">
                    <h3 className="text-lg font-bold text-slate-300 mb-6 flex items-center gap-2">
                        <Clock size={20} className="text-red-400" />
                        Golden Hour Analysis: Heatmap
                        <span className="text-xs font-normal text-slate-500 ml-2">(‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤)</span>
                    </h3>
                    <div className="min-w-[800px]">
                        <div className="flex mb-1">
                            <div className="w-16 shrink-0"></div>
                            {Array(24).fill(0).map((_, i) => <div key={i} className="flex-1 text-center text-[10px] text-slate-500">{i}</div>)}
                        </div>
                        {heatmapData.grid.map((dayRow, dayIndex) => (
                            <div key={dayIndex} className="flex mb-1 h-8">
                                <div className="w-16 shrink-0 flex items-center justify-end pr-3 text-xs text-slate-400 font-bold">{days[dayIndex]}</div>
                                {dayRow.map((avgViews, hourIndex) => <div key={hourIndex} className="flex-1 px-[1px]"><HeatmapCell value={avgViews} max={heatmapData.max} day={dayIndex} hour={hourIndex} /></div>)}
                            </div>
                        ))}
                    </div>
                </Card>

                {/* Strategy Room */}
                <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center gap-2">
                        <Zap className="text-yellow-400" /> Strategy Room: ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå Quick Win
                    </h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <Card className="p-6 border-l-4 border-l-yellow-500 bg-gradient-to-br from-slate-800 to-slate-900">
                             <div className="flex justify-between items-start mb-4">
                                 <div><h3 className="text-slate-400 text-xs font-bold uppercase tracking-wider">Golden Time (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≠‡∏á)</h3><p className="text-xs text-slate-500">‡∏•‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ ‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p></div>
                                 <Clock className="text-yellow-500 opacity-80" />
                             </div>
                             {heatmapData.best.val > 0 ? (
                                <div className="mt-2"><div className="text-3xl font-bold text-white mb-1">‡∏ß‡∏±‡∏ô{days[heatmapData.best.day]} <span className="text-yellow-400">{heatmapData.best.hour}:00</span> ‡∏ô.</div><div className="text-xs text-green-400 bg-green-900/30 inline-block px-2 py-1 rounded">Avg: {Math.round(heatmapData.best.val).toLocaleString()} views</div></div>
                             ) : (<p className="text-slate-500 italic mt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</p>)}
                        </Card>
                        <Card className="p-6 border-l-4 border-l-blue-500 bg-gradient-to-br from-slate-800 to-slate-900">
                             <div className="flex justify-between items-start mb-4">
                                 <div><h3 className="text-slate-400 text-xs font-bold uppercase tracking-wider">Winning Duration (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß)</h3><p className="text-xs text-slate-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏ä‡∏≠‡∏ö‡∏î‡∏π‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p></div>
                                 <Timer className="text-blue-500 opacity-80" />
                             </div>
                             {durationStats.avg > 0 ? (
                                <div className="mt-2"><div className="text-3xl font-bold text-white mb-1">{durationStats.label}</div><div className="text-xs text-blue-300 bg-blue-900/30 inline-block px-2 py-1 rounded">‡∏ä‡∏ô‡∏∞‡πÄ‡∏•‡∏¥‡∏®‡∏î‡πâ‡∏ß‡∏¢ Avg: {Math.round(durationStats.avg).toLocaleString()} views</div></div>
                             ) : (<p className="text-slate-500 italic mt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Duration</p>)}
                        </Card>
                        <Card className="p-6 border-l-4 border-l-purple-500 bg-gradient-to-br from-slate-800 to-slate-900">
                             <div className="flex justify-between items-start mb-4">
                                 <div><h3 className="text-slate-400 text-xs font-bold uppercase tracking-wider">Magic Keywords (‡∏Ñ‡∏≥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</h3><p className="text-xs text-slate-500">‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏ö‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡∏õ‡∏±‡∏á‡πÜ</p></div>
                                 <Type className="text-purple-500 opacity-80" />
                             </div>
                             <div className="mt-2 space-y-2">
                                {keywordStats.length > 0 ? (
                                    keywordStats.map((k, i) => (
                                        <div key={i} className="flex justify-between items-center border-b border-slate-700/50 pb-1 last:border-0"><span className="font-bold text-white text-lg">"{k.word}"</span><span className="text-xs text-slate-400">{Math.round(k.avg).toLocaleString()} views</span></div>
                                    ))
                                ) : (<p className="text-slate-500 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Keywords</p>)}
                             </div>
                        </Card>
                    </div>
                </div>

                {/* 3D Dataverse */}
                <Card className="p-0 border-blue-500/30 mt-8 overflow-hidden relative">
                    <div className="absolute top-0 left-0 w-full h-full bg-slate-900 z-0"></div>
                    <div className="relative z-10 p-4 border-b border-slate-700/50 bg-slate-800/80 backdrop-blur-sm flex justify-between items-center">
                        <div>
                            <h3 className="text-lg font-bold text-blue-300 flex items-center gap-2"><Box size={20} className="text-blue-400" /> Content Impact Matrix (3D)</h3>
                        </div>
                    </div>
                    <div className="relative z-10 bg-slate-900/50 min-h-[500px]">
                        <GhostDataverse data={data} selectedChannels={selectedChannels} colors={COLORS} />
                    </div>
                    <div className="relative z-10"><KeyTakeaways heatmapData={heatmapData} durationStats={durationStats} days={days} /></div>
                </Card>

                {/* AI Analyst */}
                <Card className="p-0 border-yellow-500/30 mt-8">
                   <div className="bg-gradient-to-r from-yellow-900/20 to-slate-900 p-4 border-b border-slate-800 flex justify-between items-center">
                      <div className="flex items-center gap-2">
                          <Brain className="text-yellow-400" />
                          <h3 className="text-lg font-bold text-yellow-100">AI Analyst (Gemini)</h3>
                      </div>
                      {!aiAnalysis && (
                        <div className="flex gap-2">
                           <input type="password" placeholder="‡πÉ‡∏™‡πà Gemini API Key" className="bg-slate-950 border border-slate-700 rounded px-3 py-1 text-sm text-slate-300 focus:outline-none focus:border-yellow-500 w-40 md:w-auto" value={aiKey} onChange={e => setAiKey(e.target.value)} />
                           <button onClick={handleAIAnalyze} disabled={aiLoading} className="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-1 rounded text-sm font-bold transition-colors disabled:opacity-50 flex items-center gap-2">{aiLoading ? <RefreshCw className="animate-spin" size={14}/> : '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå'}</button>
                        </div>
                      )}
                   </div>
                   <div className="p-6 bg-slate-900/50 min-h-[150px]">
                      {aiLoading ? (
                        <div className="space-y-3 animate-pulse"><div className="h-4 bg-slate-800 rounded w-3/4"></div><div className="h-4 bg-slate-800 rounded w-1/2"></div></div>
                      ) : aiAnalysis ? (
                        <div className="prose prose-invert max-w-none"><pre className="whitespace-pre-wrap font-sans text-slate-300 text-sm leading-relaxed">{aiAnalysis}</pre><button onClick={() => setAiAnalysis(null)} className="mt-4 text-xs text-slate-500 underline hover:text-slate-300">‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button></div>
                      ) : (
                        <div className="flex flex-col items-center justify-center text-slate-500 h-full py-8"><Brain size={48} className="mb-2 opacity-20" /><p className="text-sm">‡πÉ‡∏™‡πà API Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p></div>
                      )}
                   </div>
                </Card>

              </main>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GhostChannelBattleApp />);
    </script>
</body>
</html>
